sequenceDiagram
    participant CS as Charging Station (OCTT)
    participant CSMS as CSMS (System Under Test)

    Note over CS, CSMS: Test Case: TC_C_47_CSMS
    Note over CS, CSMS: Stop Transaction with a Master Pass - With UI - All transactions
    Note over CS, CSMS: Use Case: C16 | Requirement: C16_FR_01

    Note over CS, CSMS: Prerequisites
    Note over CS, CSMS: State is EnergyTransferStarted for EVSE 1 with valid_idtoken
    Note over CS, CSMS: State is EnergyTransferStarted for EVSE 2 with valid_idtoken2
    Note over CS, CSMS: An idToken with MasterPass as GroupId is configured

    Note over CS, CSMS: Step 1: Master Pass Authentication
    CS->>CSMS: AuthorizeRequest
    Note right of CS: idToken.idToken: [Configured masterpass_idtoken_idtoken]<br/>idToken.type: [Configured masterpass_idtoken_type]

    CSMS-->>CS: AuthorizeResponse
    Note left of CSMS: idTokenInfo.status: Accepted<br/>idTokenInfo.groupIdToken.idToken: masterPassGroupId

    Note over CS, CSMS: User selects to stop ALL transactions via UI

    Note over CS, CSMS: Step 3: Stop EVSE 1 transaction
    CS->>CSMS: TransactionEventRequest
    Note right of CS: eventType: Ended<br/>transactionInfo.stoppedReason: MasterPass<br/>idToken.idToken: [Configured masterpass_idtoken_idtoken]<br/>idToken.type: [Configured masterpass_idtoken_type]

    CSMS-->>CS: TransactionEventResponse for EVSE 1
    Note left of CSMS: idTokenInfo.status: Accepted<br/>idTokenInfo.groupIdToken.idToken: masterPassGroupId

    Note over CS, CSMS: Step 5: Stop EVSE 2 transaction
    CS->>CSMS: TransactionEventRequest
    Note right of CS: eventType: Ended<br/>transactionInfo.stoppedReason: MasterPass<br/>idToken.idToken: [Configured masterpass_idtoken_idtoken]<br/>idToken.type: [Configured masterpass_idtoken_type]

    CSMS-->>CS: TransactionEventResponse for EVSE 2
    Note left of CSMS: idTokenInfo.status: Accepted<br/>idTokenInfo.groupIdToken.idToken: masterPassGroupId

    Note over CS, CSMS: Result: All transactions stopped, cables unlocked
    Note over CS, CSMS: Tool Validations: Step 2/4 require Accepted + masterPassGroupId
